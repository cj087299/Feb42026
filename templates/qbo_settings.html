<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickBooks Settings - VZT Accounting</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-links a, .logout-btn {
            padding: 8px 16px;
            border-radius: 5px;
            text-decoration: none;
            color: #667eea;
            background: #f0f0f0;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        .nav-links a:hover, .logout-btn:hover {
            background: #667eea;
            color: white;
        }

        .main-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .info-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #555;
        }

        .info-value {
            color: #333;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.expired {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.warning {
            background: #fff3cd;
            color: #856404;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .instructions {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #0066cc;
            margin-bottom: 20px;
        }

        .instructions h3 {
            color: #0066cc;
            margin-bottom: 10px;
        }

        .instructions ol {
            margin-left: 20px;
            line-height: 1.8;
        }

        .instructions a {
            color: #0066cc;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öôÔ∏è QuickBooks Online Settings</h1>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/invoices">Invoices</a>
                <a href="/cashflow">Cash Flow</a>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="main-content">
            <div class="alert" id="alertBox"></div>

            <div class="section">
                <h2>Current QBO Connection Status</h2>
                <div class="info-box" id="statusBox">
                    <p style="text-align: center; color: #999;">Loading...</p>
                </div>
            </div>

            <div class="section">
                <h2>Connect to QuickBooks Online</h2>
                
                <div class="instructions">
                    <h3>üîó Option 1: Connect with OAuth 2.0 (Recommended)</h3>
                    <p>Click the button below to connect to QuickBooks Online. You'll be redirected to QuickBooks to log in with your username and password. After authorization, your tokens will be automatically saved and shared across all users.</p>
                    
                    <div class="form-group">
                        <label for="oauthClientId">Client ID *</label>
                        <input type="text" id="oauthClientId" name="oauthClientId" placeholder="Enter your QBO Client ID">
                        <div class="help-text">Your QuickBooks OAuth Client ID from the Developer Portal</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="oauthClientSecret">Client Secret *</label>
                        <input type="password" id="oauthClientSecret" name="oauthClientSecret" placeholder="Enter your QBO Client Secret">
                        <div class="help-text">Your QuickBooks OAuth Client Secret from the Developer Portal</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="oauthRedirectUri">Redirect URI *</label>
                        <input type="text" id="oauthRedirectUri" name="oauthRedirectUri" placeholder="https://your-domain.com/api/qbo/oauth/callback">
                        <div class="help-text">Must match the redirect URI configured in your QBO app. Use: <code id="currentRedirectUri"></code></div>
                    </div>
                    
                    <button type="button" class="btn btn-primary" onclick="initiateOAuth()">
                        <span id="oauthButtonText">üîê Connect to QuickBooks</span>
                    </button>
                    
                    <p style="margin-top: 15px; color: #666; font-size: 13px;">
                        <strong>Note:</strong> Make sure the redirect URI above is registered in your QuickBooks app settings.
                    </p>
                </div>
            </div>

            <div class="section">
                <h2>Manual Credentials Entry</h2>
                
                <div class="instructions">
                    <h3>üìã Option 2: Enter Credentials Manually</h3>
                    <p>If you already have tokens, you can enter them manually below.</p>
                    <ol>
                        <li>Go to the <a href="https://developer.intuit.com/" target="_blank">Intuit Developer Portal</a></li>
                        <li>Sign in and navigate to your app's "Keys & credentials" section</li>
                        <li>Copy your <strong>Client ID</strong> and <strong>Client Secret</strong></li>
                        <li>Use the provided tokens from the problem statement or follow OAuth flow to get new tokens</li>
                        <li>Enter all credentials below and click "Save Credentials"</li>
                    </ol>
                    <p style="margin-top: 10px;"><strong>Note:</strong> These credentials will be shared across all users. The refresh token is valid for 101 days.</p>
                </div>

                <form id="credentialsForm">
                    <div class="form-group">
                        <label for="clientId">Client ID *</label>
                        <input type="text" id="clientId" name="clientId" required>
                        <div class="help-text">Your QuickBooks OAuth Client ID</div>
                    </div>

                    <div class="form-group">
                        <label for="clientSecret">Client Secret *</label>
                        <input type="password" id="clientSecret" name="clientSecret" required>
                        <div class="help-text">Your QuickBooks OAuth Client Secret</div>
                    </div>

                    <div class="form-group">
                        <label for="refreshToken">Refresh Token *</label>
                        <input type="text" id="refreshToken" name="refreshToken" required>
                        <div class="help-text">Long-lived token (valid for 101 days)</div>
                    </div>

                    <div class="form-group">
                        <label for="realmId">Realm ID (Company ID) *</label>
                        <input type="text" id="realmId" name="realmId" required>
                        <div class="help-text">Your QuickBooks Company ID</div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <span id="saveButtonText">Save Credentials</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="refreshToken()">
                        <span id="refreshButtonText">Refresh Access Token</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = message;
            alertBox.className = `alert ${type}`;
            alertBox.style.display = 'block';
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 5000);
        }

        function formatDate(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            return date.toLocaleString();
        }

        function getTokenStatus(expiresAt) {
            if (!expiresAt) return { text: 'Unknown', class: 'warning' };
            
            const now = new Date();
            const expires = new Date(expiresAt);
            const hoursUntilExpiry = (expires - now) / (1000 * 60 * 60);
            
            if (hoursUntilExpiry < 0) {
                return { text: 'Expired', class: 'expired' };
            } else if (hoursUntilExpiry < 24) {
                return { text: `Expires in ${Math.round(hoursUntilExpiry)} hours`, class: 'warning' };
            } else if (hoursUntilExpiry < 168) { // Less than a week
                return { text: `Expires in ${Math.round(hoursUntilExpiry / 24)} days`, class: 'warning' };
            } else {
                return { text: 'Active', class: 'active' };
            }
        }

        async function loadStatus() {
            try {
                const response = await fetch('/api/qbo/credentials');
                
                if (response.status === 404) {
                    document.getElementById('statusBox').innerHTML = `
                        <div class="info-row">
                            <span class="info-label">Status</span>
                            <span class="info-value">
                                <span class="status-badge warning">Not Configured</span>
                            </span>
                        </div>
                        <p style="margin-top: 15px; color: #666;">
                            No QBO credentials have been configured yet. Please enter your credentials below.
                        </p>
                    `;
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('Failed to load credentials');
                }
                
                const data = await response.json();
                
                const accessTokenStatus = getTokenStatus(data.access_token_expires_at);
                const refreshTokenStatus = getTokenStatus(data.refresh_token_expires_at);
                
                document.getElementById('statusBox').innerHTML = `
                    <div class="info-row">
                        <span class="info-label">Client ID</span>
                        <span class="info-value">${data.client_id || 'Not set'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Realm ID</span>
                        <span class="info-value">${data.realm_id || 'Not set'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Access Token</span>
                        <span class="info-value">
                            <span class="status-badge ${accessTokenStatus.class}">${accessTokenStatus.text}</span>
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Refresh Token</span>
                        <span class="info-value">
                            <span class="status-badge ${refreshTokenStatus.class}">${refreshTokenStatus.text}</span>
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Last Updated</span>
                        <span class="info-value">${formatDate(data.updated_at)}</span>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading status:', error);
                document.getElementById('statusBox').innerHTML = `
                    <p style="color: #dc3545;">Failed to load credential status</p>
                `;
            }
        }

        document.getElementById('credentialsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitButton = document.querySelector('button[type="submit"]');
            const buttonText = document.getElementById('saveButtonText');
            const originalText = buttonText.textContent;
            
            submitButton.disabled = true;
            buttonText.innerHTML = '<span class="loading"></span> Saving...';
            
            try {
                const formData = {
                    client_id: document.getElementById('clientId').value,
                    client_secret: document.getElementById('clientSecret').value,
                    refresh_token: document.getElementById('refreshToken').value,
                    realm_id: document.getElementById('realmId').value
                };
                
                const response = await fetch('/api/qbo/credentials', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert(data.message || 'Credentials saved successfully!', 'success');
                    // Clear sensitive fields
                    document.getElementById('clientSecret').value = '';
                    document.getElementById('refreshToken').value = '';
                    // Reload status
                    await loadStatus();
                } else {
                    showAlert(data.error || 'Failed to save credentials', 'error');
                }
            } catch (error) {
                console.error('Error saving credentials:', error);
                showAlert('An error occurred while saving credentials', 'error');
            } finally {
                submitButton.disabled = false;
                buttonText.textContent = originalText;
            }
        });

        async function refreshToken() {
            const refreshButton = document.querySelector('.btn-secondary');
            const buttonText = document.getElementById('refreshButtonText');
            const originalText = buttonText.textContent;
            
            refreshButton.disabled = true;
            buttonText.innerHTML = '<span class="loading"></span> Refreshing...';
            
            try {
                const response = await fetch('/api/qbo/refresh', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert(data.message || 'Token refreshed successfully!', 'success');
                    await loadStatus();
                } else {
                    showAlert(data.error || 'Failed to refresh token', 'error');
                }
            } catch (error) {
                console.error('Error refreshing token:', error);
                showAlert('An error occurred while refreshing token', 'error');
            } finally {
                refreshButton.disabled = false;
                buttonText.textContent = originalText;
            }
        }

        async function initiateOAuth() {
            const clientId = document.getElementById('oauthClientId').value;
            const clientSecret = document.getElementById('oauthClientSecret').value;
            const redirectUri = document.getElementById('oauthRedirectUri').value;
            
            if (!clientId || !clientSecret || !redirectUri) {
                showAlert('Please fill in all OAuth fields (Client ID, Client Secret, and Redirect URI)', 'error');
                return;
            }
            
            const buttonText = document.getElementById('oauthButtonText');
            const originalText = buttonText.textContent;
            buttonText.innerHTML = '<span class="loading"></span> Connecting...';
            
            try {
                const response = await fetch('/api/qbo/oauth/authorize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        client_id: clientId,
                        client_secret: clientSecret,
                        redirect_uri: redirectUri
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Open QuickBooks authorization in a popup window
                    const width = 600;
                    const height = 700;
                    const left = (screen.width / 2) - (width / 2);
                    const top = (screen.height / 2) - (height / 2);
                    
                    const popup = window.open(
                        data.authorization_url,
                        'QuickBooks Authorization',
                        `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
                    );
                    
                    if (!popup) {
                        showAlert('Please allow popups for this site to connect to QuickBooks', 'error');
                        buttonText.textContent = originalText;
                        return;
                    }
                    
                    // Poll for popup closure or message from callback
                    const pollTimer = setInterval(() => {
                        if (popup.closed) {
                            clearInterval(pollTimer);
                            buttonText.textContent = originalText;
                        }
                    }, 500);
                    
                    // Listen for message from OAuth callback popup
                    window.addEventListener('message', function oauthCallback(event) {
                        // Verify the message origin for security
                        if (event.origin !== window.location.origin) {
                            return;
                        }
                        
                        if (event.data.type === 'qbo_oauth_success') {
                            clearInterval(pollTimer);
                            window.removeEventListener('message', oauthCallback);
                            showAlert('Successfully connected to QuickBooks Online!', 'success');
                            buttonText.textContent = originalText;
                            // Reload the status to show updated credentials
                            loadStatus();
                        } else if (event.data.type === 'qbo_oauth_error') {
                            clearInterval(pollTimer);
                            window.removeEventListener('message', oauthCallback);
                            showAlert(event.data.message || 'Failed to connect to QuickBooks', 'error');
                            buttonText.textContent = originalText;
                        }
                    });
                } else {
                    showAlert(data.error || 'Failed to initiate OAuth', 'error');
                    buttonText.textContent = originalText;
                }
            } catch (error) {
                console.error('Error initiating OAuth:', error);
                showAlert('An error occurred while initiating OAuth', 'error');
                buttonText.textContent = originalText;
            }
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/login';
            }
        }

        // Set current redirect URI on page load
        window.addEventListener('DOMContentLoaded', () => {
            const currentUrl = window.location.origin + '/api/qbo/oauth/callback';
            document.getElementById('currentRedirectUri').textContent = currentUrl;
            document.getElementById('oauthRedirectUri').value = currentUrl;
            
            // Check if we came back from successful OAuth
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('oauth_success') === 'true') {
                showAlert('Successfully connected to QuickBooks Online!', 'success');
                // Clean up the URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });

        // Load status on page load
        loadStatus();
    </script>
</body>
</html>

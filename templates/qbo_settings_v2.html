<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickBooks Settings v2 - VZT Accounting</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-links a, .logout-btn {
            padding: 8px 16px;
            border-radius: 5px;
            text-decoration: none;
            color: #667eea;
            background: #f0f0f0;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        .nav-links a:hover, .logout-btn:hover {
            background: #667eea;
            color: white;
        }

        .main-content {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #333;
            font-size: 28px;
            margin-bottom: 15px;
        }

        .section p {
            color: #666;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .status-box {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .status-row:last-child {
            border-bottom: none;
        }

        .status-label {
            font-weight: 600;
            color: #555;
        }

        .status-value {
            color: #333;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-badge.connected {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.warning {
            background: #fff3cd;
            color: #856404;
        }

        .connect-button {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 18px 40px;
            background: #2ca01c;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(44, 160, 28, 0.3);
        }

        .connect-button:hover {
            background: #239916;
            box-shadow: 0 6px 20px rgba(44, 160, 28, 0.4);
            transform: translateY(-2px);
        }

        .connect-button:active {
            transform: translateY(0);
        }

        .connect-button:disabled {
            background: #999;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .disconnect-button {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 18px 40px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
            margin-right: 15px;
        }

        .disconnect-button:hover {
            background: #c82333;
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
            transform: translateY(-2px);
        }

        .disconnect-button:active {
            transform: translateY(0);
        }

        .disconnect-button:disabled {
            background: #999;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .qbo-logo {
            font-size: 24px;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .info-note {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #0066cc;
            margin-top: 30px;
            text-align: left;
        }

        .info-note h3 {
            color: #0066cc;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .info-note p {
            color: #333;
            font-size: 14px;
            margin-bottom: 0;
        }

        .loading-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid #ffffff;
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .version-badge {
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .btn-diagnostics {
            padding: 10px 20px;
            background: #f0f0f0;
            color: #667eea;
            border: 1px solid #667eea;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-diagnostics:hover {
            background: #667eea;
            color: white;
        }

        .diagnostic-box {
            display: none;
            margin-top: 20px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: left;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öôÔ∏è QuickBooks Settings <span class="version-badge">v2</span></h1>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/invoices">Invoices</a>
                <a href="/cashflow">Cash Flow</a>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="main-content">
            <div class="alert" id="alertBox"></div>

            <div class="section">
                <h2>QuickBooks Online Connection</h2>
                <p>Connect your QuickBooks Online account to sync invoices, manage cash flow, and access financial data.</p>

                <div class="status-box" id="statusBox">
                    <p style="text-align: center; color: #999;">Loading connection status...</p>
                </div>

                <div id="buttonContainer" style="margin-top: 30px;">
                    <button class="disconnect-button" id="disconnectButton" onclick="disconnectFromQuickBooks()" style="display: none;">
                        <span>üîå</span>
                        <span>Disconnect</span>
                    </button>
                    <button class="connect-button" id="connectButton" onclick="connectToQuickBooks()">
                        <span class="qbo-logo">üìä</span>
                        <span id="buttonText">Connect to QuickBooks</span>
                    </button>
                </div>

                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn-diagnostics" onclick="showDiagnostics()">
                        üîç View OAuth Diagnostics
                    </button>
                </div>

                <div id="diagnosticBox" class="diagnostic-box">
                    <h3 style="margin-bottom: 10px; color: #333;">OAuth Configuration Diagnostics</h3>
                    <div id="diagnosticContent">Loading...</div>
                </div>

                <div class="info-note">
                    <h3>‚ÑπÔ∏è How It Works</h3>
                    <p>
                        Click the "Connect to QuickBooks" button above to authorize access to your QuickBooks Online account. 
                        You'll be redirected to QuickBooks where you can log in with your QuickBooks credentials and grant access. 
                        Once authorized, your tokens will be securely stored and you'll be able to access your financial data.
                    </p>
                    <p style="margin-top: 15px;">
                        <strong>Troubleshooting:</strong> If you don't see a QuickBooks login screen:
                    </p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Make sure your browser allows popups for this site</li>
                        <li>Check that the redirect URI is registered in your QuickBooks app</li>
                        <li>Verify your client credentials are correct</li>
                        <li>Click "View OAuth Diagnostics" above for detailed information</li>
                    </ul>
                    <p style="margin-top: 15px; font-size: 12px; color: #666; border-top: 1px solid #ccc; padding-top: 10px;">
                        <strong>Last Revised:</strong> <span id="lastRevised"></span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = message;
            alertBox.className = `alert ${type}`;
            alertBox.style.display = 'block';
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 5000);
        }

        function formatDate(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            return date.toLocaleString();
        }

        function getConnectionStatus(data) {
            if (!data || !data.realm_id) {
                return {
                    text: 'Not Connected',
                    class: 'disconnected',
                    connected: false
                };
            }

            const now = new Date();
            const accessExpires = data.access_token_expires_at ? new Date(data.access_token_expires_at) : null;
            const refreshExpires = data.refresh_token_expires_at ? new Date(data.refresh_token_expires_at) : null;

            if (refreshExpires && refreshExpires < now) {
                return {
                    text: 'Connection Expired',
                    class: 'disconnected',
                    connected: false
                };
            }

            if (accessExpires && accessExpires < now) {
                return {
                    text: 'Token Needs Refresh',
                    class: 'warning',
                    connected: true
                };
            }

            return {
                text: 'Connected',
                class: 'connected',
                connected: true
            };
        }

        async function loadStatus() {
            try {
                const response = await fetch('/api/qbo/credentials');
                const statusBox = document.getElementById('statusBox');
                const connectButton = document.getElementById('connectButton');
                const disconnectButton = document.getElementById('disconnectButton');
                const buttonContainer = document.getElementById('buttonContainer');
                const buttonText = document.getElementById('buttonText');
                const lastRevised = document.getElementById('lastRevised');

                if (response.status === 404) {
                    const data404 = await response.json();
                    const isAdmin = data404.is_admin;
                    
                    statusBox.innerHTML = `
                        <div class="status-row">
                            <span class="status-label">Connection Status</span>
                            <span class="status-value">
                                <span class="status-badge disconnected">Not Connected</span>
                            </span>
                        </div>
                        <p style="margin-top: 15px; color: #666; text-align: center;">
                            ${isAdmin ? 'Click the button below to connect to QuickBooks Online' : 'QuickBooks is not connected yet. Please contact an administrator.'}
                        </p>
                    `;
                    
                    if (isAdmin) {
                        // Show only Connect button when not connected
                        connectButton.style.display = 'inline-flex';
                        disconnectButton.style.display = 'none';
                        buttonText.textContent = 'Connect to QuickBooks';
                    } else {
                        // Hide buttons for non-admin users
                        buttonContainer.style.display = 'none';
                    }
                    
                    if (lastRevised) {
                        lastRevised.textContent = 'Never';
                    }
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to load connection status');
                }

                const data = await response.json();
                const status = getConnectionStatus(data);
                const isAdmin = data.is_admin;

                statusBox.innerHTML = `
                    <div class="status-row">
                        <span class="status-label">Connection Status</span>
                        <span class="status-value">
                            <span class="status-badge ${status.class}">${status.text}</span>
                        </span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Company ID</span>
                        <span class="status-value">${data.realm_id || 'Not set'}</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Last Connected</span>
                        <span class="status-value">${formatDate(data.updated_at)}</span>
                    </div>
                `;

                // Show buttons or status message based on user role
                if (isAdmin) {
                    // Admin: Show Connect/Disconnect buttons
                    buttonContainer.style.display = 'block';
                    if (data.realm_id) {
                        connectButton.style.display = 'none';
                        disconnectButton.style.display = 'inline-flex';
                    } else {
                        connectButton.style.display = 'inline-flex';
                        disconnectButton.style.display = 'none';
                        buttonText.textContent = 'Connect to QuickBooks';
                    }
                } else {
                    // Non-admin: Show read-only status message
                    const envName = data.qbo_environment || 'Production';
                    buttonContainer.innerHTML = `
                        <div style="padding: 20px; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 10px; text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
                            <div style="font-size: 18px; font-weight: 600; color: #0c4a6e; margin-bottom: 8px;">
                                Connected to VZT ${envName} Data
                            </div>
                            <div style="font-size: 14px; color: #075985;">
                                Your team administrator has configured QuickBooks access for everyone.
                            </div>
                        </div>
                    `;
                }
                
                // Update last revised date
                if (lastRevised && data.updated_at) {
                    lastRevised.textContent = formatDate(data.updated_at);
                } else if (lastRevised) {
                    lastRevised.textContent = 'Never';
                }
            } catch (error) {
                console.error('Error loading status:', error);
                document.getElementById('statusBox').innerHTML = `
                    <p style="color: #dc3545; text-align: center;">Failed to load connection status</p>
                `;
                // Try to show connect button on error for admins
                document.getElementById('buttonContainer').style.display = 'block';
                document.getElementById('connectButton').style.display = 'inline-flex';
                document.getElementById('disconnectButton').style.display = 'none';
                if (lastRevised) {
                    lastRevised.textContent = 'Unknown';
                }
            }
        }

        async function connectToQuickBooks() {
            const connectButton = document.getElementById('connectButton');
            const buttonText = document.getElementById('buttonText');
            const originalText = buttonText.textContent;

            connectButton.disabled = true;
            buttonText.innerHTML = '<span class="loading-spinner"></span> Connecting...';

            try {
                // Call the backend to initiate OAuth with hardcoded credentials
                const response = await fetch('/api/qbo/oauth/authorize-v2', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    // Open QuickBooks authorization in a popup window
                    const width = 600;
                    const height = 700;
                    const left = (screen.width / 2) - (width / 2);
                    const top = (screen.height / 2) - (height / 2);

                    const popup = window.open(
                        data.authorization_url,
                        'QuickBooks Authorization',
                        `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
                    );

                    if (!popup) {
                        showAlert('Please allow popups for this site to connect to QuickBooks', 'error');
                        connectButton.disabled = false;
                        buttonText.textContent = originalText;
                        return;
                    }

                    // Flag to track if OAuth callback was successful (takes precedence over polling)
                    let oauthCompleted = false;
                    let pollTimerCleared = false;
                    
                    // Poll for popup closure or message from callback
                    const pollTimer = setInterval(() => {
                        if (popup.closed && !pollTimerCleared && !oauthCompleted) {
                            clearInterval(pollTimer);
                            pollTimerCleared = true;
                            connectButton.disabled = false;
                            buttonText.textContent = originalText;
                        }
                    }, 500);

                    // Listen for message from OAuth callback popup
                    window.addEventListener('message', function oauthCallback(event) {
                        // Verify the message origin for security
                        if (event.origin !== window.location.origin) {
                            return;
                        }

                        if (event.data.type === 'qbo_oauth_success') {
                            oauthCompleted = true;
                            if (!pollTimerCleared) {
                                clearInterval(pollTimer);
                                pollTimerCleared = true;
                            }
                            window.removeEventListener('message', oauthCallback);
                            showAlert('Successfully connected to QuickBooks Online!', 'success');
                            connectButton.disabled = false;
                            buttonText.textContent = originalText;
                            // Reload the status to show updated credentials
                            loadStatus();
                        } else if (event.data.type === 'qbo_oauth_error') {
                            oauthCompleted = true;
                            if (!pollTimerCleared) {
                                clearInterval(pollTimer);
                                pollTimerCleared = true;
                            }
                            window.removeEventListener('message', oauthCallback);
                            showAlert(event.data.message || 'Failed to connect to QuickBooks', 'error');
                            connectButton.disabled = false;
                            buttonText.textContent = originalText;
                        }
                    });
                } else {
                    showAlert(data.error || 'Failed to initiate connection', 'error');
                    connectButton.disabled = false;
                    buttonText.textContent = originalText;
                }
            } catch (error) {
                console.error('Error connecting to QuickBooks:', error);
                showAlert('An error occurred while connecting to QuickBooks', 'error');
                connectButton.disabled = false;
                buttonText.textContent = originalText;
            }
        }

        async function disconnectFromQuickBooks() {
            const disconnectButton = document.getElementById('disconnectButton');
            const connectButton = document.getElementById('connectButton');
            
            if (!confirm('Are you sure you want to disconnect from QuickBooks? This will remove all stored credentials.')) {
                return;
            }
            
            disconnectButton.disabled = true;
            connectButton.disabled = true;
            disconnectButton.innerHTML = '<span class="loading-spinner"></span> Disconnecting...';
            
            try {
                const response = await fetch('/api/qbo/disconnect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert('Successfully disconnected from QuickBooks', 'success');
                    // Reload the status to update UI
                    await loadStatus();
                } else {
                    showAlert(data.error || 'Failed to disconnect from QuickBooks', 'error');
                    disconnectButton.disabled = false;
                    connectButton.disabled = false;
                    disconnectButton.innerHTML = '<span>üîå</span><span>Disconnect</span>';
                }
            } catch (error) {
                console.error('Error disconnecting from QuickBooks:', error);
                showAlert('An error occurred while disconnecting from QuickBooks', 'error');
                disconnectButton.disabled = false;
                connectButton.disabled = false;
                disconnectButton.innerHTML = '<span>üîå</span><span>Disconnect</span>';
            }
        }

        async function showDiagnostics() {
            const diagnosticBox = document.getElementById('diagnosticBox');
            const diagnosticContent = document.getElementById('diagnosticContent');
            
            if (diagnosticBox.style.display === 'none') {
                diagnosticBox.style.display = 'block';
                diagnosticContent.innerHTML = '<p style="text-align: center;">Loading diagnostics...</p>';
                
                try {
                    const response = await fetch('/api/qbo/oauth/diagnostic');
                    if (!response.ok) {
                        throw new Error('Failed to load diagnostics');
                    }
                    
                    const data = await response.json();
                    
                    // Build diagnostic display
                    let html = '<div style="font-family: monospace; font-size: 12px;">';
                    
                    // Current Setup
                    html += '<h4 style="color: #667eea; margin-top: 0;">Current Setup</h4>';
                    html += '<table style="width: 100%; border-collapse: collapse;">';
                    html += `<tr><td style="padding: 5px; border-bottom: 1px solid #ddd;"><strong>Redirect URI:</strong></td><td style="padding: 5px; border-bottom: 1px solid #ddd; word-break: break-all;">${data.current_setup.redirect_uri}</td></tr>`;
                    html += `<tr><td style="padding: 5px; border-bottom: 1px solid #ddd;"><strong>Client ID:</strong></td><td style="padding: 5px; border-bottom: 1px solid #ddd;">${data.current_setup.client_id_in_use}</td></tr>`;
                    html += `<tr><td style="padding: 5px; border-bottom: 1px solid #ddd;"><strong>Using HTTPS:</strong></td><td style="padding: 5px; border-bottom: 1px solid #ddd;">${data.current_setup.using_https ? '‚úÖ Yes' : '‚ùå No'}</td></tr>`;
                    html += '</table>';
                    
                    // Troubleshooting Checklist
                    html += '<h4 style="color: #667eea; margin-top: 20px;">Troubleshooting Checklist</h4>';
                    html += '<ul style="margin-left: 0; padding-left: 0; list-style: none;">';
                    data.troubleshooting_checklist.forEach(item => {
                        const icon = item.status === 'ok' ? '‚úÖ' : item.status === 'warning' ? '‚ö†Ô∏è' : '‚ùì';
                        html += `<li style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px;">`;
                        html += `<div style="font-weight: bold;">${icon} ${item.item}</div>`;
                        html += `<div style="color: #666; margin-top: 5px;">Value: ${item.value}</div>`;
                        html += `<div style="color: #0066cc; margin-top: 5px; font-size: 11px;">${item.action}</div>`;
                        html += `</li>`;
                    });
                    html += '</ul>';
                    
                    // Next Steps
                    html += '<h4 style="color: #667eea; margin-top: 20px;">Next Steps</h4>';
                    html += '<ol style="margin-left: 20px;">';
                    data.next_steps.forEach(step => {
                        html += `<li style="margin-bottom: 8px; color: #333;">${step}</li>`;
                    });
                    html += '</ol>';
                    
                    // Common Issues
                    html += '<h4 style="color: #667eea; margin-top: 20px;">Common Issues</h4>';
                    html += '<div style="background: white; padding: 10px; border-radius: 5px; margin-bottom: 10px;">';
                    html += '<strong>No Login Screen Appears:</strong>';
                    html += '<ul style="margin-left: 20px; margin-top: 5px;">';
                    data.common_issues.no_login_screen.forEach(issue => {
                        html += `<li style="margin-bottom: 5px; color: #666;">${issue}</li>`;
                    });
                    html += '</ul></div>';
                    
                    html += '<div style="background: white; padding: 10px; border-radius: 5px;">';
                    html += '<strong>403 Forbidden Error:</strong>';
                    html += '<ul style="margin-left: 20px; margin-top: 5px;">';
                    data.common_issues['403_forbidden'].forEach(issue => {
                        html += `<li style="margin-bottom: 5px; color: #666;">${issue}</li>`;
                    });
                    html += '</ul></div>';
                    
                    html += '</div>';
                    
                    diagnosticContent.innerHTML = html;
                } catch (error) {
                    console.error('Error loading diagnostics:', error);
                    diagnosticContent.innerHTML = '<p style="color: #dc3545;">Failed to load diagnostics. Please check the browser console for errors.</p>';
                }
            } else {
                diagnosticBox.style.display = 'none';
            }
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/login';
            }
        }

        // Load status on page load
        loadStatus();
    </script>
</body>
</html>

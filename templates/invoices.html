<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Management - VZT Accounting</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/ai-chat.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <a href="/" class="logo">ðŸ’° VZT Accounting</a>
            <nav class="nav">
                <a href="/">Home</a>
                <a href="/invoices">Invoices</a>
                <a href="/cashflow">Cash Flow</a>
                <a href="/health">Status</a>
                <a href="#" onclick="logout(); return false;">Logout</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <h1 style="margin-bottom: 1rem;">Invoice Management</h1>
        <p style="color: var(--text-secondary); margin-bottom: 2rem;">View and manage your QuickBooks Online invoices</p>

        <div class="table-container">
            <h2 style="margin-bottom: 1.5rem;">Filter Invoices</h2>
            <form id="filterForm" class="form-row" style="margin-bottom: 2rem;">
                <div class="form-group">
                    <label for="start_date">Start Date</label>
                    <input type="date" id="start_date" name="start_date">
                </div>
                <div class="form-group">
                    <label for="end_date">End Date</label>
                    <input type="date" id="end_date" name="end_date">
                </div>
                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status" name="status">
                        <option value="">All Statuses</option>
                        <option value="paid">Paid</option>
                        <option value="pending">Pending</option>
                        <option value="overdue">Overdue</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="customer_id">Customer ID</label>
                    <input type="text" id="customer_id" name="customer_id" placeholder="Enter customer ID">
                </div>
                <div class="form-group">
                    <label for="min_amount">Min Amount</label>
                    <input type="number" id="min_amount" name="min_amount" placeholder="0.00" step="0.01">
                </div>
                <div class="form-group">
                    <label for="max_amount">Max Amount</label>
                    <input type="number" id="max_amount" name="max_amount" placeholder="0.00" step="0.01">
                </div>
                <div class="form-group">
                    <label for="region">Region</label>
                    <input type="text" id="region" name="region" placeholder="Enter region">
                </div>
                <div class="form-group">
                    <label for="sort_by">Sort By</label>
                    <select id="sort_by" name="sort_by">
                        <option value="due_date">Due Date</option>
                        <option value="amount">Amount</option>
                        <option value="customer">Customer</option>
                        <option value="status">Status</option>
                    </select>
                </div>
            </form>
            <button type="button" class="btn" onclick="loadInvoices()">Apply Filters</button>
            <button type="button" class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
        </div>

        <div id="invoiceResults" style="margin-top: 2rem;">
            <!-- Results will be loaded here -->
        </div>
    </main>

    <script src="/static/js/common.js"></script>
    <script>
        // Load invoices on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadInvoices();
        });

        function clearFilters() {
            document.getElementById('filterForm').reset();
            loadInvoices();
        }

        async function loadInvoices() {
            const resultsDiv = document.getElementById('invoiceResults');
            showLoading('invoiceResults');

            try {
                // Build query parameters from form
                const form = document.getElementById('filterForm');
                const formData = new FormData(form);
                const params = new URLSearchParams();
                
                for (const [key, value] of formData.entries()) {
                    if (value) {
                        params.append(key, value);
                    }
                }

                const queryString = params.toString();
                const endpoint = queryString ? `/api/invoices?${queryString}` : '/api/invoices';
                
                const invoices = await fetchAPI(endpoint);

                if (!invoices || invoices.length === 0) {
                    resultsDiv.innerHTML = `
                        <div class="table-container">
                            <p style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                No invoices found. Try adjusting your filters.
                            </p>
                        </div>
                    `;
                    return;
                }

                // Build table
                let tableHTML = `
                    <div class="table-container">
                        <h2 style="margin-bottom: 1rem;">Invoices (${invoices.length})</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Invoice ID</th>
                                    <th>Customer</th>
                                    <th>Amount</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                    <th>VZT Rep</th>
                                    <th>Sent to VZT Rep</th>
                                    <th>Customer Portal</th>
                                    <th>Portal Submission</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                invoices.forEach(invoice => {
                    const metadata = invoice.metadata || {};
                    const invoiceId = invoice.id || invoice.doc_number || 'N/A';
                    tableHTML += `
                        <tr data-invoice-id="${invoiceId}">
                            <td>${invoiceId}</td>
                            <td>${invoice.customer || invoice.customer_id || 'N/A'}</td>
                            <td>${formatCurrency(invoice.amount || 0)}</td>
                            <td>${invoice.due_date ? formatDate(invoice.due_date) : 'N/A'}</td>
                            <td><span class="status-badge ${getStatusClass(invoice.status)}">${invoice.status || 'N/A'}</span></td>
                            <td class="editable-cell" data-field="vzt_rep">${metadata.vzt_rep || '-'}</td>
                            <td class="editable-cell" data-field="sent_to_vzt_rep_date">${metadata.sent_to_vzt_rep_date ? formatDate(metadata.sent_to_vzt_rep_date) : '-'}</td>
                            <td class="editable-cell" data-field="customer_portal">${metadata.customer_portal || '-'}</td>
                            <td class="editable-cell" data-field="customer_portal_submission_date">${metadata.customer_portal_submission_date ? formatDate(metadata.customer_portal_submission_date) : '-'}</td>
                            <td><button class="btn btn-secondary" onclick="editInvoiceMetadata('${invoiceId}')">Edit</button></td>
                        </tr>
                    `;
                });

                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;

                resultsDiv.innerHTML = tableHTML;

            } catch (error) {
                showError('invoiceResults', `Failed to load invoices: ${error.message}`);
            }
        }

        async function editInvoiceMetadata(invoiceId) {
            // Create modal for editing metadata
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
            
            // Get current metadata
            let metadata = {};
            try {
                const response = await fetch(`/api/invoices/${invoiceId}/metadata`);
                if (response.ok) {
                    metadata = await response.json();
                }
            } catch (e) {
                console.error('Failed to fetch metadata:', e);
            }
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%;">
                    <h2 style="margin-bottom: 1.5rem;">Edit Invoice Metadata - ${invoiceId}</h2>
                    <form id="metadataForm">
                        <div class="form-group">
                            <label for="vzt_rep">VZT Rep</label>
                            <input type="text" id="vzt_rep" name="vzt_rep" value="${metadata.vzt_rep || ''}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="sent_to_vzt_rep_date">Sent to VZT Rep Date</label>
                            <input type="date" id="sent_to_vzt_rep_date" name="sent_to_vzt_rep_date" value="${metadata.sent_to_vzt_rep_date || ''}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="customer_portal">Customer Portal</label>
                            <input type="text" id="customer_portal" name="customer_portal" value="${metadata.customer_portal || ''}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="customer_portal_submission_date">Customer Portal Submission Date</label>
                            <input type="date" id="customer_portal_submission_date" name="customer_portal_submission_date" value="${metadata.customer_portal_submission_date || ''}" class="form-control">
                        </div>
                        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                            <button type="submit" class="btn">Save</button>
                            <button type="button" class="btn btn-secondary" onclick="this.closest('[style*=fixed]').remove()">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle form submission
            document.getElementById('metadataForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const data = {};
                for (const [key, value] of formData.entries()) {
                    if (value) data[key] = value;
                }
                
                try {
                    const response = await fetch(`/api/invoices/${invoiceId}/metadata`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        modal.remove();
                        loadInvoices(); // Reload the table
                        showSuccess('invoiceResults', 'Metadata saved successfully!');
                        setTimeout(() => loadInvoices(), 2000);
                    } else {
                        throw new Error('Failed to save metadata');
                    }
                } catch (error) {
                    alert('Failed to save metadata: ' + error.message);
                }
            });
        }
        
        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                console.error('Logout failed:', error);
                window.location.href = '/login';
            }
        }
    </script>
    <script src="/static/js/ai-chat.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cash Flow Projection - QBO Cash Flow</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <a href="/" class="logo">ðŸ’° QBO Cash Flow</a>
            <nav class="nav">
                <a href="/">Home</a>
                <a href="/invoices">Invoices</a>
                <a href="/cashflow">Cash Flow</a>
                <a href="/health">Status</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <h1 style="margin-bottom: 1rem;">Cash Flow Projection</h1>
        <p style="color: var(--text-secondary); margin-bottom: 2rem;">AI-powered cash flow forecasting based on your invoices</p>

        <div class="info-card">
            <h3>ðŸ“Š How it works</h3>
            <p>Our AI model analyzes your invoice history and uses machine learning to predict when payments will be received, giving you accurate cash flow projections for planning ahead.</p>
        </div>

        <div class="table-container">
            <h2 style="margin-bottom: 1.5rem;">Projection Settings</h2>
            <form id="projectionForm">
                <div class="form-group">
                    <label for="days">Projection Period (days)</label>
                    <select id="days" name="days">
                        <option value="30">30 days (1 month)</option>
                        <option value="60">60 days (2 months)</option>
                        <option value="90">90 days (3 months)</option>
                        <option value="180">180 days (6 months)</option>
                    </select>
                </div>
                <button type="button" class="btn" onclick="loadProjection()">Generate Projection</button>
            </form>
        </div>

        <div id="projectionResults" style="margin-top: 2rem;">
            <!-- Results will be loaded here -->
        </div>
    </main>

    <script src="/static/js/common.js"></script>
    <script>
        // Load projection on page load with default 30 days
        window.addEventListener('DOMContentLoaded', () => {
            loadProjection();
        });

        async function loadProjection() {
            const resultsDiv = document.getElementById('projectionResults');
            showLoading('projectionResults');

            try {
                const days = document.getElementById('days').value;
                const data = await fetchAPI(`/api/cashflow?days=${days}`);

                // Display results
                let html = `
                    <div class="table-container">
                        <h2 style="margin-bottom: 1rem;">Projection Results</h2>
                        <div style="padding: 2rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 2rem;">
                                <div>
                                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.5rem;">Projection Period</p>
                                    <p style="font-size: 2rem; font-weight: bold; color: var(--primary-color);">${data.days} days</p>
                                </div>
                                <div>
                                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.5rem;">Projected Balance Change</p>
                                    <p style="font-size: 2rem; font-weight: bold; color: ${data.projected_balance_change >= 0 ? 'var(--success-color)' : 'var(--error-color)'};">
                                        ${formatCurrency(data.projected_balance_change || 0)}
                                    </p>
                                </div>
                            </div>
                `;

                // If there are more details in the projection, display them
                if (typeof data.projected_balance_change === 'object') {
                    html += `
                        <div style="margin-top: 2rem;">
                            <h3 style="margin-bottom: 1rem;">Detailed Breakdown</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Projected Inflow</th>
                                        <th>Projected Outflow</th>
                                        <th>Net Change</th>
                                        <th>Cumulative Balance</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    // If projection is an object with daily data
                    for (const [date, value] of Object.entries(data.projected_balance_change)) {
                        html += `
                            <tr>
                                <td>${formatDate(date)}</td>
                                <td>${formatCurrency(value.inflow || 0)}</td>
                                <td>${formatCurrency(value.outflow || 0)}</td>
                                <td style="color: ${value.net >= 0 ? 'var(--success-color)' : 'var(--error-color)'};">
                                    ${formatCurrency(value.net || 0)}
                                </td>
                                <td style="font-weight: bold;">${formatCurrency(value.balance || 0)}</td>
                            </tr>
                        `;
                    }

                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                html += `
                            <div style="margin-top: 2rem; padding: 1rem; background: var(--background); border-radius: 8px;">
                                <p style="color: var(--text-secondary); font-size: 0.875rem;">
                                    <strong>Note:</strong> This projection is based on AI-powered predictions of invoice payment dates. 
                                    Actual results may vary based on customer payment behavior and other factors.
                                </p>
                            </div>
                        </div>
                    </div>
                `;

                resultsDiv.innerHTML = html;

            } catch (error) {
                showError('projectionResults', `Failed to load cash flow projection: ${error.message}`);
            }
        }
    </script>
</body>
</html>
